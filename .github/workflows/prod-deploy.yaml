name: Deploy to Azure Production

on:
  workflow_dispatch: {}
  push:
    tags:
      - 'v*'

permissions:
  id-token: write
  contents: read

env:
  # Base naming components
  ORG_NAME: nevridge
  APP_NAME: taskflow
  ENV: prod
  LOCATION: eastus
  
  # Legacy names (for reference during migration)
  # RESOURCE_GROUP: TaskFlowRG
  # WEBAPP_NAME: taskflowapi2074394909
  # ACR_NAME: taskflowregistry
  # ACR_IMAGE_NAME: taskflowapi9
  # APP_SERVICE_PLAN: TaskFlowAppServicePlan

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compute resource names
        run: |
          # Base components
          ORG="${{ env.ORG_NAME }}"
          APP="${{ env.APP_NAME }}"
          ENV="${{ env.ENV }}"
          
          # Computed names following naming convention: {org}-{app}-{env}-{type}
          RG_NAME="${ORG}-${APP}-${ENV}-rg"
          ACI_NAME="${ORG}-${APP}-${ENV}-aci"
          DNS_NAME_LABEL="${APP}-${ENV}"
          
          # Special: ACR (no hyphens, alphanumeric only)
          ACR_NAME="${ORG}${APP}${ENV}acr"
          
          # Image name (simple, descriptive)
          ACR_IMAGE_NAME="${APP}api"
          
          # Export to environment
          echo "RG_NAME=$RG_NAME" >> $GITHUB_ENV
          echo "ACI_NAME=$ACI_NAME" >> $GITHUB_ENV
          echo "DNS_NAME_LABEL=$DNS_NAME_LABEL" >> $GITHUB_ENV
          echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV
          echo "ACR_IMAGE_NAME=$ACR_IMAGE_NAME" >> $GITHUB_ENV
          
          # Log computed names for debugging
          echo "=========================================="
          echo "Computed Azure Resource Names:"
          echo "=========================================="
          echo "Resource Group:     $RG_NAME"
          echo "ACI Container:      $ACI_NAME"
          echo "DNS Label:          $DNS_NAME_LABEL"
          echo "Full DNS:           $DNS_NAME_LABEL.${{ env.LOCATION }}.azurecontainer.io"
          echo "Container Registry: $ACR_NAME"
          echo "Image Name:         $ACR_IMAGE_NAME"
          echo "Location:           ${{ env.LOCATION }}"
          echo "=========================================="

      - name: Validate resource names
        run: |
          # Function to validate length
          validate_length() {
            local name=$1
            local min=$2
            local max=$3
            local resource=$4
            local len=${#name}
            if [ $len -lt $min ] || [ $len -gt $max ]; then
              echo "ERROR: $resource name '$name' length ($len) must be between $min and $max characters"
              exit 1
            fi
          }
          
          # Function to validate alphanumeric only
          validate_alphanumeric() {
            local name=$1
            local resource=$2
            if ! [[ "$name" =~ ^[a-z0-9]+$ ]]; then
              echo "ERROR: $resource name '$name' must contain only lowercase alphanumeric characters"
              exit 1
            fi
          }
          
          # Function to validate DNS label format
          validate_dns_label() {
            local name=$1
            local resource=$2
            if ! [[ "$name" =~ ^[a-z0-9]([a-z0-9-]*[a-z0-9])?$ ]]; then
              echo "ERROR: $resource name '$name' must start and end with lowercase alphanumeric characters, and can contain hyphens"
              exit 1
            fi
          }
          
          echo "Validating resource names against Azure constraints..."
          
          # Validate ACR name (5-50 chars, alphanumeric only)
          validate_length "$ACR_NAME" 5 50 "ACR"
          validate_alphanumeric "$ACR_NAME" "ACR"
          
          # Validate ACI name (1-63 chars, alphanumeric and hyphens)
          validate_length "$ACI_NAME" 1 63 "ACI"
          validate_dns_label "$ACI_NAME" "ACI"
          
          # Validate DNS label (1-63 chars, alphanumeric and hyphens)
          validate_length "$DNS_NAME_LABEL" 1 63 "DNS Label"
          validate_dns_label "$DNS_NAME_LABEL" "DNS Label"
          
          # Validate Resource Group name (1-90 chars)
          validate_length "$RG_NAME" 1 90 "Resource Group"
          
          echo "✓ All resource names passed validation"

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify subscription
        run: |
          az account show

      - name: Register Azure Container Instances provider
        run: |
          echo "Registering Microsoft.ContainerInstance provider"
          az provider register --namespace Microsoft.ContainerInstance --wait || true
          az provider show --namespace Microsoft.ContainerInstance --query "registrationState" -o tsv

      - name: Ensure resource group exists
        run: |
          if az group show -n ${{ env.RG_NAME }} >/dev/null 2>&1; then
            echo "Resource group ${{ env.RG_NAME }} exists"
          else
            echo "Creating resource group ${{ env.RG_NAME }}"
            az group create -n ${{ env.RG_NAME }} -l ${{ env.LOCATION }}
          fi

      - name: Ensure ACR exists
        run: |
          if az acr show -n ${{ env.ACR_NAME }} -g ${{ env.RG_NAME }} >/dev/null 2>&1; then
            echo "ACR ${{ env.ACR_NAME }} exists"
          else
            echo "Creating ACR ${{ env.ACR_NAME }}"
            az acr create -n ${{ env.ACR_NAME }} -g ${{ env.RG_NAME }} --sku Basic --admin-enabled true
          fi

      - name: Build and push Docker image to ACR
        run: |
          az acr build \
            --registry ${{ env.ACR_NAME }} \
            --image ${{ env.ACR_IMAGE_NAME }}:latest \
            --image ${{ env.ACR_IMAGE_NAME }}:${{ github.sha }} \
            --file TaskFlow.Api/Dockerfile \
            .

      - name: Delete existing ACI if it exists
        run: |
          echo "Pre-deployment cleanup: Checking for existing ACI container '${{ env.ACI_NAME }}'"
          if az container show -g ${{ env.RG_NAME }} -n ${{ env.ACI_NAME }} >/dev/null 2>&1; then
            echo "Found existing ACI container '${{ env.ACI_NAME }}'. Deleting to ensure fresh deployment..."
            az container delete -g ${{ env.RG_NAME }} -n ${{ env.ACI_NAME }} --yes
            echo "Waiting for container deletion to complete (polling for up to 60 seconds)..."
            TIMEOUT=60
            INTERVAL=2
            ELAPSED=0
            while az container show -g ${{ env.RG_NAME }} -n ${{ env.ACI_NAME }} >/dev/null 2>&1; do
              if [ $ELAPSED -ge $TIMEOUT ]; then
                echo "Timeout waiting for container deletion. Exiting with error."
                exit 1
              fi
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
            done
            echo "✓ Container deletion confirmed. DNS label is now available."
          else
            echo "No existing ACI container found with name '${{ env.ACI_NAME }}'. Proceeding with deployment."
          fi

      - name: Create ACI from ACR image
        run: |
          echo "Creating ACI container '${{ env.ACI_NAME }}' with DNS label '${{ env.DNS_NAME_LABEL }}'..."
          az container create \
            --resource-group ${{ env.RG_NAME }} \
            --name ${{ env.ACI_NAME }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.ACR_IMAGE_NAME }}:latest \
            --registry-login-server ${{ env.ACR_NAME }}.azurecr.io \
            --registry-username $(az acr credential show -n ${{ env.ACR_NAME }} --query username -o tsv) \
            --registry-password $(az acr credential show -n ${{ env.ACR_NAME }} --query "passwords[0].value" -o tsv) \
            --cpu 1 --memory 1.5 \
            --os-type Linux \
            --ports 8080 \
            --dns-name-label ${{ env.DNS_NAME_LABEL }}
          echo "✓ ACI container created successfully"

      - name: Wait for ACI to be ready
        run: |
          echo "========================================"
          echo "Waiting for production deployment to be ready..."
          echo "========================================"
          FQDN_VALUE=""
          for i in {1..30}; do
            FQDN_VALUE=$(az container show -g ${{ env.RG_NAME }} -n ${{ env.ACI_NAME }} --query ipAddress.fqdn -o tsv)
            if [ -n "$FQDN_VALUE" ] && [ "$FQDN_VALUE" != "null" ]; then
              echo "FQDN=$FQDN_VALUE" >> $GITHUB_ENV
              echo ""
              echo "========================================"
              echo "Production Deployment Ready!"
              echo "========================================"
              echo "Resource Group:     ${{ env.RG_NAME }}"
              echo "ACI Container:      ${{ env.ACI_NAME }}"
              echo "DNS Label:          ${{ env.DNS_NAME_LABEL }}"
              echo "Full DNS (FQDN):    $FQDN_VALUE"
              echo "API Endpoint:       http://$FQDN_VALUE:8080"
              echo "Health Check:       http://$FQDN_VALUE:8080/health"
              echo "========================================"
              break
            fi
            echo "Waiting for ACI... (attempt $i/30)"
            sleep 5
          done
          if [ -z "$FQDN_VALUE" ] || [ "$FQDN_VALUE" = "null" ]; then
            echo "Error: FQDN was not obtained after waiting for ACI. Exiting."
            exit 1
          fi

      - name: Verify health check
        run: |
          echo "Testing http://$FQDN:8080/health"
          for i in {1..10}; do
            status=$(curl -s -o /dev/null -w '%{http_code}' --max-time 5 http://$FQDN:8080/health || echo "000")
            echo "Health check status: $status"
            if [ "$status" = "200" ]; then
              echo ""
              echo "=========================================="
              echo "Production Deployment Complete!"
              echo "=========================================="
              echo "API Endpoint:   http://$FQDN:8080"
              echo "Health Check:   http://$FQDN:8080/health"
              echo "=========================================="
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 3
          done
          echo "Health check failed after 10 attempts"
          exit 1