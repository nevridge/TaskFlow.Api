name: Deploy to Azure Production

on:
  workflow_dispatch: {}
  push:
    tags:
      - 'v*'

permissions:
  id-token: write
  contents: read

env:
  # Base naming components
  ORG_NAME: nevridge
  APP_NAME: taskflow
  ENV: prod
  LOCATION: eastus
  
  # Legacy names (for reference during migration)
  # RESOURCE_GROUP: TaskFlowRG
  # WEBAPP_NAME: taskflowapi2074394909
  # ACR_NAME: taskflowregistry
  # ACR_IMAGE_NAME: taskflowapi9
  # APP_SERVICE_PLAN: TaskFlowAppServicePlan

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compute resource names
        run: |
          # Base components
          ORG="${{ env.ORG_NAME }}"
          APP="${{ env.APP_NAME }}"
          ENV="${{ env.ENV }}"
          
          # Computed names following naming convention: {org}-{app}-{env}-{type}
          RG_NAME="${ORG}-${APP}-${ENV}-rg"
          WEB_NAME="${ORG}-${APP}-${ENV}-web"
          PLAN_NAME="${ORG}-${APP}-${ENV}-plan"
          
          # Special: ACR (no hyphens, alphanumeric only)
          ACR_NAME="${ORG}${APP}${ENV}acr"
          
          # Image name (simple, descriptive)
          ACR_IMAGE_NAME="${APP}api"
          
          # Export to environment
          echo "RG_NAME=$RG_NAME" >> $GITHUB_ENV
          echo "WEB_NAME=$WEB_NAME" >> $GITHUB_ENV
          echo "PLAN_NAME=$PLAN_NAME" >> $GITHUB_ENV
          echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV
          echo "ACR_IMAGE_NAME=$ACR_IMAGE_NAME" >> $GITHUB_ENV
          
          # Log computed names for debugging
          echo "=========================================="
          echo "Computed Azure Resource Names:"
          echo "=========================================="
          echo "Resource Group:     $RG_NAME"
          echo "Web App:            $WEB_NAME"
          echo "App Service Plan:   $PLAN_NAME"
          echo "Container Registry: $ACR_NAME"
          echo "Image Name:         $ACR_IMAGE_NAME"
          echo "Location:           ${{ env.LOCATION }}"
          echo "=========================================="

      - name: Validate resource names
        run: |
          # Function to validate length
          validate_length() {
            local name=$1
            local min=$2
            local max=$3
            local resource=$4
            local len=${#name}
            if [ $len -lt $min ] || [ $len -gt $max ]; then
              echo "ERROR: $resource name '$name' length ($len) must be between $min and $max characters"
              exit 1
            fi
          }
          
          # Function to validate alphanumeric only
          validate_alphanumeric() {
            local name=$1
            local resource=$2
            if ! [[ "$name" =~ ^[a-z0-9]+$ ]]; then
              echo "ERROR: $resource name '$name' must contain only lowercase alphanumeric characters"
              exit 1
            fi
          }
          
          # Function to validate alphanumeric with hyphens
          validate_alphanumeric_hyphen() {
            local name=$1
            local resource=$2
            if ! [[ "$name" =~ ^[a-z0-9]([a-z0-9-]*[a-z0-9])?$ ]]; then
              echo "ERROR: $resource name '$name' must start and end with lowercase alphanumeric, can contain hyphens"
              exit 1
            fi
          }
          
          echo "Validating resource names against Azure constraints..."
          
          # Validate ACR name (5-50 chars, alphanumeric only)
          validate_length "$ACR_NAME" 5 50 "ACR"
          validate_alphanumeric "$ACR_NAME" "ACR"
          
          # Validate Web App name (2-60 chars, alphanumeric and hyphens)
          validate_length "$WEB_NAME" 2 60 "Web App"
          validate_alphanumeric_hyphen "$WEB_NAME" "Web App"
          
          # Validate App Service Plan name (1-40 chars, alphanumeric and hyphens)
          validate_length "$PLAN_NAME" 1 40 "App Service Plan"
          validate_alphanumeric_hyphen "$PLAN_NAME" "App Service Plan"
          
          # Validate Resource Group name (1-90 chars)
          validate_length "$RG_NAME" 1 90 "Resource Group"
          
          echo "✓ All resource names passed validation"

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify subscription
        run: |
          az account show

      - name: Ensure resource group exists
        run: |
          if az group show -n ${{ env.RG_NAME }} >/dev/null 2>&1; then
            echo "Resource group ${{ env.RG_NAME }} exists"
          else
            echo "Creating resource group ${{ env.RG_NAME }}"
            az group create -n ${{ env.RG_NAME }} -l ${{ env.LOCATION }}
          fi

      - name: Ensure ACR exists
        run: |
          if az acr show -n ${{ env.ACR_NAME }} -g ${{ env.RG_NAME }} >/dev/null 2>&1; then
            echo "ACR ${{ env.ACR_NAME }} exists"
          else
            echo "Creating ACR ${{ env.ACR_NAME }}"
            az acr create -n ${{ env.ACR_NAME }} -g ${{ env.RG_NAME }} --sku Basic --admin-enabled true
          fi

      - name: Build and push Docker image to ACR
        run: |
          az acr build \
            --registry ${{ env.ACR_NAME }} \
            --image ${{ env.ACR_IMAGE_NAME }}:latest \
            --image ${{ env.ACR_IMAGE_NAME }}:${{ github.sha }} \
            --file TaskFlow.Api/Dockerfile \
            .

      - name: Ensure App Service Plan exists
        run: |
          if az appservice plan show -n ${{ env.PLAN_NAME }} -g ${{ env.RG_NAME }} >/dev/null 2>&1; then
            echo "App Service Plan ${{ env.PLAN_NAME }} exists"
          else
            echo "App Service Plan ${{ env.PLAN_NAME }} does not exist"
            echo "Checking for existing App Service Plans in resource group that can be reused..."
            
            # Try to find any existing Linux App Service Plan in the resource group
            EXISTING_PLAN=$(az appservice plan list -g ${{ env.RG_NAME }} --query "[?contains(toLower(kind), 'linux')].name" -o tsv | head -n 1)
            
            if [ -n "$EXISTING_PLAN" ]; then
              echo "Found existing Linux App Service Plan: $EXISTING_PLAN"
              echo "Original intended plan name: ${{ env.PLAN_NAME }}"
              echo "Using existing plan instead of creating a new one"
              echo "PLAN_NAME=$EXISTING_PLAN" >> $GITHUB_ENV
            else
              echo "No existing Linux App Service Plans found in resource group"
              echo "Attempting to create new App Service Plan ${{ env.PLAN_NAME }}"
              echo "NOTE: Using Free tier (F1) due to Azure subscription quota limitations."
              echo "To use Basic (B1) or higher tiers, request quota increase in Azure Portal."
              
              # Capture output for error reporting
              CREATE_OUTPUT=$(mktemp)
              if az appservice plan create \
                -n ${{ env.PLAN_NAME }} \
                -g ${{ env.RG_NAME }} \
                --is-linux \
                --sku F1 2>&1 | tee "$CREATE_OUTPUT"; then
                # Success - clean up temp file
                rm -f "$CREATE_OUTPUT"
              else
                # Failure - display error and clean up
                echo ""
                echo "=========================================="
                echo "ERROR: Failed to create App Service Plan"
                echo "=========================================="
                echo ""
                cat "$CREATE_OUTPUT"
                rm -f "$CREATE_OUTPUT"
                echo ""
                echo "This deployment requires an App Service Plan, but your Azure subscription"
                echo "does not have quota to create one."
                echo ""
                echo "ACTION REQUIRED:"
                echo "1. Go to Azure Portal (https://portal.azure.com)"
                echo "2. Navigate to: Subscriptions > Your Subscription > Usage + quotas"
                echo "3. Search for 'App Service' or 'Web App' quotas"
                echo "4. Request a quota increase for at least 1 Free (F1) or Basic (B1) App Service Plan"
                echo ""
                echo "Alternatively, you can manually create an App Service Plan in the resource"
                echo "group '${{ env.RG_NAME }}' and re-run this deployment."
                echo "=========================================="
                exit 1
              fi
            fi
          fi

      - name: Ensure Web App exists
        run: |
          if az webapp show -n ${{ env.WEB_NAME }} -g ${{ env.RG_NAME }} >/dev/null 2>&1; then
            echo "Web App ${{ env.WEB_NAME }} exists"
          else
            echo "Creating Web App ${{ env.WEB_NAME }}"
            az webapp create \
              -n ${{ env.WEB_NAME }} \
              -g ${{ env.RG_NAME }} \
              --plan ${{ env.PLAN_NAME }} \
              --deployment-container-image-name ${{ env.ACR_NAME }}.azurecr.io/${{ env.ACR_IMAGE_NAME }}:latest
          fi

      - name: Enable system-assigned identity
        run: |
          az webapp identity assign \
            --resource-group ${{ env.RG_NAME }} \
            --name ${{ env.WEB_NAME }}

      - name: Get webapp managed identity principal ID
        id: get_principal
        run: |
          principalId=$(az webapp show \
            --resource-group ${{ env.RG_NAME }} \
            --name ${{ env.WEB_NAME }} \
            --query identity.principalId -o tsv)
          echo "PRINCIPAL_ID=$principalId" >> $GITHUB_ENV

      - name: Grant AcrPull role to webapp identity
        continue-on-error: true
        run: |
          az role assignment create \
            --assignee ${{ env.PRINCIPAL_ID }} \
            --role AcrPull \
            --scope $(az acr show --name ${{ env.ACR_NAME }} --query id -o tsv) || true

      - name: Configure webapp to use managed identity for ACR
        run: |
          az resource update \
            --ids /subscriptions/$(az account show --query id -o tsv)/resourceGroups/${{ env.RG_NAME }}/providers/Microsoft.Web/sites/${{ env.WEB_NAME }}/config/web \
            --set properties.acrUseManagedIdentityCreds=true

      - name: Set the container image
        run: |
          az webapp config container set \
            --name ${{ env.WEB_NAME }} \
            --resource-group ${{ env.RG_NAME }} \
            --container-image-name ${{ env.ACR_NAME }}.azurecr.io/${{ env.ACR_IMAGE_NAME }}:latest \
            --container-registry-url https://${{ env.ACR_NAME }}.azurecr.io

      - name: Configure health check path
        run: |
          az webapp config set \
            --resource-group ${{ env.RG_NAME }} \
            --name ${{ env.WEB_NAME }} \
            --generic-configurations '{"healthCheckPath": "/health"}'

      - name: Restart webapp
        run: |
          az webapp restart \
            --resource-group ${{ env.RG_NAME }} \
            --name ${{ env.WEB_NAME }}

      - name: Verify health check
        run: |
          echo "Waiting for app to restart..."
          sleep 30
          echo "Checking health endpoint..."
          for i in {1..10}; do
            status=$(curl -s -o /dev/null -w '%{http_code}' --max-time 10 https://${{ env.WEB_NAME }}.azurewebsites.net/health || echo "000")
            echo "Health check status: $status"
            if [ "$status" = "200" ]; then
              echo "Health check passed"
              echo ""
              echo "=========================================="
              echo "Production Deployment Complete!"
              echo "=========================================="
              echo "Web App URL: https://${{ env.WEB_NAME }}.azurewebsites.net"
              echo "Health Check: https://${{ env.WEB_NAME }}.azurewebsites.net/health"
              echo "=========================================="
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          echo "Health check failed after 10 attempts"
          exit 1